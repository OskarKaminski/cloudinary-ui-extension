<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css">
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
</head>

<body>
    <form>
        <button id='selectBtn' class="cf-btn-primary .cf-block" onclick="clickInput()">Select Files to Upload</button>
        <input id="fileElem" class="cf-form-input" type="file" accept="image/*" style='display:none' onchange="handleFiles(this.files)">
    </form>

    <br />
    <div id='upload-status'></div>
    <script>
        'use strict';
        const cloudName = 'insert cloud name';
        const unsignedUploadPreset = 'preset name';

        function clickInput() {
            let fileElem = document.getElementById('fileElem');
            fileElem.click();
        }

        function initExtension(extension, url) {
            extension.window.startAutoResizer()

            const urlField = extension.entry.fields.url;
            urlField.setValue(url)
        }

        function uploadFile(file) {
            let uploadStatus = document.getElementById('upload-status'),
                url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`,
                xhr = new XMLHttpRequest(),
                fd = new FormData();
            xhr.open('POST', url, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            uploadStatus.innerHTML = '';
            uploadStatus.style.color = 'inherit';

            xhr.upload.addEventListener("progress", function (e) {
                let progress = Math.round((e.loaded * 100.0) / e.total);
                console.log(`fileuploadprogress data.loaded: ${e.loaded}, data.total: ${e.total}, progress: ${progress}`);
                uploadStatus.innerHTML = `${progress}%`;
            });

            xhr.onreadystatechange = function (e) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    uploadStatus.style.color = 'green';
                    uploadStatus.innerHTML = 'Upload Successful';
                    var response = JSON.parse(xhr.responseText);
                    var url = response.secure_url;
                    window.contentfulExtension.init(ext => initExtension(ext, url))
                }
                else {
                    uploadStatus.style.color = 'red';
                    uploadStatus.innerHTML = 'Upload Failed';
                }
            };

            fd.append('upload_preset', unsignedUploadPreset);
            fd.append('tags', 'browser_upload');
            fd.append('file', file);
            xhr.send(fd);
        }

        function handleFiles(files) {
            for (var i = 0; i < files.length; i++) {
                uploadFile(files[i]);
            }
        };
    </script>
</body>

</html>